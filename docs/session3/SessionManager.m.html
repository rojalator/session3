<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>session3.SessionManager API documentation</title>
    <meta name="description" content="A persistent session manager class for Quixote 2.x." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">


    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#session3.SessionManager.SessionManager">SessionManager</a></span>
        
          
  <ul>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.__init__">__init__</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.clear_session">clear_session</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.expire_session">expire_session</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.finish_failed_request">finish_failed_request</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.finish_successful_request">finish_successful_request</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.get_session">get_session</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.has_session">has_session</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.has_session_cookie">has_session_cookie</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.maintain_session">maintain_session</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.new_session">new_session</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.revoke_session_cookie">revoke_session_cookie</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.set_session_cookie">set_session_cookie</a></li>
    <li class="mono"><a href="#session3.SessionManager.SessionManager.start_request">start_request</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">session3.SessionManager</span> module</h1>
  <p>A persistent session manager class for Quixote 2.x.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager" class="source">
    <div class="codehilite"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A persistent session manager class for Quixote 2.x.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">quixote</span> <span class="kn">import</span> <span class="n">get_request</span><span class="p">,</span> <span class="n">get_publisher</span><span class="p">,</span> <span class="n">get_cookie</span><span class="p">,</span> <span class="n">get_response</span>
<span class="kn">from</span> <span class="nn">quixote.util</span> <span class="kn">import</span> <span class="n">randbytes</span>
<span class="kn">from</span> <span class="nn">session3.Session</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="k">class</span> <span class="nc">SessionManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A persistent session manager for Quixote.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ACCESS_TIME_RESOLUTION</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># in seconds</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_obj</span><span class="p">,</span> <span class="n">session_class</span><span class="o">=</span><span class="n">Session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __init__ takes a session store instance and (optionally) the</span>
<span class="sd">        session class to use for storing session information.  (This</span>
<span class="sd">        defaults to `Session.Session`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span> <span class="o">=</span> <span class="n">session_class</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> at </span><span class="si">%x</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;() -&gt; Session</span>

<span class="sd">        Fetch or create a session object for the current session, and</span>
<span class="sd">        return it.  If a session cookie is found in the HTTP request</span>
<span class="sd">        object, use it to look up and return an existing session object.</span>
<span class="sd">        If no session cookie is found, create a new session.</span>

<span class="sd">        Note that this method does *not* cause the new session to be</span>
<span class="sd">        stored in the session manager, nor does it drop a session cookie</span>
<span class="sd">        on the user.  Those are both the responsibility of</span>
<span class="sd">        finish_successful_request().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_publisher</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session_id</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">load_session</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_session</span><span class="p">()</span>

        <span class="n">session</span><span class="o">.</span><span class="n">_set_access_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ACCESS_TIME_RESOLUTION</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session</span>

    <span class="k">def</span> <span class="nf">maintain_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(session : Session) -&gt; bool</span>

<span class="sd">        Maintain session information.  This method is called after servicing</span>
<span class="sd">        an HTTP request, just before the response is returned.  If a session</span>
<span class="sd">        contains information a cookie is dropped on the client and True is</span>
<span class="sd">        returned.  If not, the session is forcibly expired and False is</span>
<span class="sd">        returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">has_info</span><span class="p">():</span>
            <span class="c"># Session has no useful info -- forget it.  If it previously</span>
            <span class="c"># had useful information and no longer does, we have to</span>
            <span class="c"># explicitly forget it.</span>
            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_session</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expire_session</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># This is the first time this session has had useful</span>
            <span class="c"># info -- store it and set the session cookie.</span>
            <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_session_id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_session_cookie</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">expire_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expire the current session, ie. revoke the session cookie from</span>
<span class="sd">        the client, remove the session object from the current request,</span>
<span class="sd">        and list it for permanent removal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revoke_session_cookie</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">has_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(session_id : string) -&gt; boolean</span>

<span class="sd">        Return true if a session identified by &#39;session_id&#39; exists in</span>
<span class="sd">        the session manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">load_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear any residual session information for this request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span>

    <span class="c"># -- Hooks into the Quixote main loop ------------------------------</span>

    <span class="k">def</span> <span class="nf">start_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called near the beginning of each request: after the HTTPRequest</span>
<span class="sd">        object has been built, but before we traverse the URL or call the</span>
<span class="sd">        callable object found by URL traversal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
        <span class="n">get_request</span><span class="p">()</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="n">session</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finish_successful_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called near the end of each successful request.  Not called if</span>
<span class="sd">        there were any errors processing the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>

        <span class="c"># keep session?</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maintain_session</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">save_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="c"># or delete, because it&#39;s expired?</span>
        <span class="k">elif</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish_failed_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called near the end of a failed request (i.e. a exception that was</span>
<span class="sd">        not a PublisherError was raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c">#### CTB: no changes below this line; stolen from SessionManager.</span>

    <span class="c"># -- Session management --------------------------------------------</span>
    <span class="c"># these build on the storage mechanism implemented by the</span>
    <span class="c"># above mapping methods, and are concerned with all the high-</span>
    <span class="c"># level details of managing web sessions</span>

    <span class="k">def</span> <span class="nf">new_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(id : string) -&gt; Session</span>

<span class="sd">        Return a new session object, ie. an instance of the session_class</span>
<span class="sd">        class passed to the constructor (defaults to Session).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;() -&gt; string</span>

<span class="sd">        Find the ID of the current session by looking for the session</span>
<span class="sd">        cookie in the request.  Return None if no such cookie or the</span>
<span class="sd">        cookie has been expired, otherwise return the cookie&#39;s value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">get_cookie</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="s">&quot;*del*&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">_make_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Generate a session ID, which is just the value of the session</span>
        <span class="c"># cookie we are about to drop on the user.  (It&#39;s also the key</span>
        <span class="c"># used with the session manager mapping interface.)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_session</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">randbytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>  <span class="c"># 64-bit random number</span>
        <span class="k">return</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">_create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Create a new session object, with no ID for now - one will</span>
        <span class="c"># be assigned later if we save the session.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_session</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_publisher</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_name</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span><span class="o">.</span><span class="n">get_environ</span><span class="p">(</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_domain</span>
        
        <span class="c"># Modified R J Ladyman 2010-11-23 to include secure and httponly as per Quixote 2.7b1</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_secure</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;secure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_httponly</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;httponly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c"># End of modification R J Ladyman 2010-11-23</span>
        <span class="n">get_response</span><span class="p">()</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>  <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">set_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(session_id : string)</span>

<span class="sd">        Ensure that a session cookie with value &#39;session_id&#39; will be</span>
<span class="sd">        returned to the client via the response object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cookie</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">revoke_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the session cookie from the remote user&#39;s session by</span>
<span class="sd">        resetting the value and maximum age in the response object.  Also</span>
<span class="sd">        remove the cookie from the request so that further processing of</span>
<span class="sd">        this request does not see the cookie&#39;s revoked value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cookie_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_cookie</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_cookie</span><span class="p">(</span><span class="n">cookie_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">get_request</span><span class="p">()</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">cookie_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">has_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">must_exist</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(must_exist : boolean = false) -&gt; bool</span>

<span class="sd">        Return true if the request already has a cookie identifying a</span>
<span class="sd">        session object.  If &#39;must_exist&#39; is true, the cookie must</span>
<span class="sd">        correspond to a currently existing session; otherwise (the</span>
<span class="sd">        default), we just check for the existence of the session cookie</span>
<span class="sd">        and don&#39;t inspect its content at all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_publisher</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">get_cookie</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">must_exist</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_session</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">


    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="session3.SessionManager.SessionManager" class="name">class <span class="ident">SessionManager</span></p>
      
  
    <div class="desc"><p>A persistent session manager for Quixote.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager" class="source">
    <div class="codehilite"><pre><span class="k">class</span> <span class="nc">SessionManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A persistent session manager for Quixote.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ACCESS_TIME_RESOLUTION</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># in seconds</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_obj</span><span class="p">,</span> <span class="n">session_class</span><span class="o">=</span><span class="n">Session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __init__ takes a session store instance and (optionally) the</span>
<span class="sd">        session class to use for storing session information.  (This</span>
<span class="sd">        defaults to `Session.Session`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span> <span class="o">=</span> <span class="n">session_class</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> at </span><span class="si">%x</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;() -&gt; Session</span>

<span class="sd">        Fetch or create a session object for the current session, and</span>
<span class="sd">        return it.  If a session cookie is found in the HTTP request</span>
<span class="sd">        object, use it to look up and return an existing session object.</span>
<span class="sd">        If no session cookie is found, create a new session.</span>

<span class="sd">        Note that this method does *not* cause the new session to be</span>
<span class="sd">        stored in the session manager, nor does it drop a session cookie</span>
<span class="sd">        on the user.  Those are both the responsibility of</span>
<span class="sd">        finish_successful_request().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_publisher</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session_id</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">load_session</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_session</span><span class="p">()</span>

        <span class="n">session</span><span class="o">.</span><span class="n">_set_access_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ACCESS_TIME_RESOLUTION</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session</span>

    <span class="k">def</span> <span class="nf">maintain_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(session : Session) -&gt; bool</span>

<span class="sd">        Maintain session information.  This method is called after servicing</span>
<span class="sd">        an HTTP request, just before the response is returned.  If a session</span>
<span class="sd">        contains information a cookie is dropped on the client and True is</span>
<span class="sd">        returned.  If not, the session is forcibly expired and False is</span>
<span class="sd">        returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">has_info</span><span class="p">():</span>
            <span class="c"># Session has no useful info -- forget it.  If it previously</span>
            <span class="c"># had useful information and no longer does, we have to</span>
            <span class="c"># explicitly forget it.</span>
            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_session</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expire_session</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># This is the first time this session has had useful</span>
            <span class="c"># info -- store it and set the session cookie.</span>
            <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_session_id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_session_cookie</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">expire_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expire the current session, ie. revoke the session cookie from</span>
<span class="sd">        the client, remove the session object from the current request,</span>
<span class="sd">        and list it for permanent removal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revoke_session_cookie</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">has_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(session_id : string) -&gt; boolean</span>

<span class="sd">        Return true if a session identified by &#39;session_id&#39; exists in</span>
<span class="sd">        the session manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">load_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear any residual session information for this request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span>

    <span class="c"># -- Hooks into the Quixote main loop ------------------------------</span>

    <span class="k">def</span> <span class="nf">start_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called near the beginning of each request: after the HTTPRequest</span>
<span class="sd">        object has been built, but before we traverse the URL or call the</span>
<span class="sd">        callable object found by URL traversal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
        <span class="n">get_request</span><span class="p">()</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="n">session</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finish_successful_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called near the end of each successful request.  Not called if</span>
<span class="sd">        there were any errors processing the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>

        <span class="c"># keep session?</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maintain_session</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">save_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="c"># or delete, because it&#39;s expired?</span>
        <span class="k">elif</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish_failed_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called near the end of a failed request (i.e. a exception that was</span>
<span class="sd">        not a PublisherError was raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c">#### CTB: no changes below this line; stolen from SessionManager.</span>

    <span class="c"># -- Session management --------------------------------------------</span>
    <span class="c"># these build on the storage mechanism implemented by the</span>
    <span class="c"># above mapping methods, and are concerned with all the high-</span>
    <span class="c"># level details of managing web sessions</span>

    <span class="k">def</span> <span class="nf">new_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(id : string) -&gt; Session</span>

<span class="sd">        Return a new session object, ie. an instance of the session_class</span>
<span class="sd">        class passed to the constructor (defaults to Session).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;() -&gt; string</span>

<span class="sd">        Find the ID of the current session by looking for the session</span>
<span class="sd">        cookie in the request.  Return None if no such cookie or the</span>
<span class="sd">        cookie has been expired, otherwise return the cookie&#39;s value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">get_cookie</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="s">&quot;*del*&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">_make_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Generate a session ID, which is just the value of the session</span>
        <span class="c"># cookie we are about to drop on the user.  (It&#39;s also the key</span>
        <span class="c"># used with the session manager mapping interface.)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_session</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">randbytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>  <span class="c"># 64-bit random number</span>
        <span class="k">return</span> <span class="nb">id</span>

    <span class="k">def</span> <span class="nf">_create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Create a new session object, with no ID for now - one will</span>
        <span class="c"># be assigned later if we save the session.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_session</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_publisher</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_name</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span><span class="o">.</span><span class="n">get_environ</span><span class="p">(</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_domain</span>
        
        <span class="c"># Modified R J Ladyman 2010-11-23 to include secure and httponly as per Quixote 2.7b1</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_secure</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;secure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">session_cookie_httponly</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;httponly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c"># End of modification R J Ladyman 2010-11-23</span>
        <span class="n">get_response</span><span class="p">()</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>  <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">set_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(session_id : string)</span>

<span class="sd">        Ensure that a session cookie with value &#39;session_id&#39; will be</span>
<span class="sd">        returned to the client via the response object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cookie</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">revoke_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the session cookie from the remote user&#39;s session by</span>
<span class="sd">        resetting the value and maximum age in the response object.  Also</span>
<span class="sd">        remove the cookie from the request so that further processing of</span>
<span class="sd">        this request does not see the cookie&#39;s revoked value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cookie_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_cookie</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_cookie</span><span class="p">(</span><span class="n">cookie_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">get_request</span><span class="p">()</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">cookie_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">has_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">must_exist</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(must_exist : boolean = false) -&gt; bool</span>

<span class="sd">        Return true if the request already has a cookie identifying a</span>
<span class="sd">        session object.  If &#39;must_exist&#39; is true, the cookie must</span>
<span class="sd">        correspond to a currently existing session; otherwise (the</span>
<span class="sd">        default), we just check for the existence of the session cookie</span>
<span class="sd">        and don&#39;t inspect its content at all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_publisher</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">get_cookie</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">must_exist</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_session</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#session3.SessionManager.SessionManager">SessionManager</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Class variables</h3>
            <div class="item">
            <p id="session3.SessionManager.SessionManager.ACCESS_TIME_RESOLUTION" class="name">var <span class="ident">ACCESS_TIME_RESOLUTION</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, store_obj, session_class=&lt;class &#39;session3.Session.Session&#39;&gt;)</p>
    </div>
    

    
  
    <div class="desc"><p><strong>init</strong> takes a session store instance and (optionally) the
session class to use for storing session information.  (This
defaults to <code>Session.Session</code>).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.__init__', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.__init__" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_obj</span><span class="p">,</span> <span class="n">session_class</span><span class="o">=</span><span class="n">Session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __init__ takes a session store instance and (optionally) the</span>
<span class="sd">    session class to use for storing session information.  (This</span>
<span class="sd">    defaults to `Session.Session`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store_obj</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span> <span class="o">=</span> <span class="n">session_class</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.clear_session">
    <p>def <span class="ident">clear_session</span>(</p><p>self, request)</p>
    </div>
    

    
  
    <div class="desc"><p>Clear any residual session information for this request.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.clear_session', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.clear_session" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">clear_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clear any residual session information for this request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.expire_session">
    <p>def <span class="ident">expire_session</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Expire the current session, ie. revoke the session cookie from
the client, remove the session object from the current request,
and list it for permanent removal.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.expire_session', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.expire_session" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">expire_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expire the current session, ie. revoke the session cookie from</span>
<span class="sd">    the client, remove the session object from the current request,</span>
<span class="sd">    and list it for permanent removal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">revoke_session_cookie</span><span class="p">()</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.finish_failed_request">
    <p>def <span class="ident">finish_failed_request</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Called near the end of a failed request (i.e. a exception that was
not a PublisherError was raised.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.finish_failed_request', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.finish_failed_request" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">finish_failed_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Called near the end of a failed request (i.e. a exception that was</span>
<span class="sd">    not a PublisherError was raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.finish_successful_request">
    <p>def <span class="ident">finish_successful_request</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Called near the end of each successful request.  Not called if
there were any errors processing the request.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.finish_successful_request', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.finish_successful_request" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">finish_successful_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Called near the end of each successful request.  Not called if</span>
<span class="sd">    there were any errors processing the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">get_request</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
    <span class="c"># keep session?</span>
    <span class="k">if</span> <span class="n">session</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maintain_session</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">save_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="c"># or delete, because it&#39;s expired?</span>
    <span class="k">elif</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expired_sessions</span><span class="p">[</span><span class="n">request</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.get_session">
    <p>def <span class="ident">get_session</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>() -&gt; Session</p>
<p>Fetch or create a session object for the current session, and
return it.  If a session cookie is found in the HTTP request
object, use it to look up and return an existing session object.
If no session cookie is found, create a new session.</p>
<p>Note that this method does <em>not</em> cause the new session to be
stored in the session manager, nor does it drop a session cookie
on the user.  Those are both the responsibility of
finish_successful_request().</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.get_session', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.get_session" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;() -&gt; Session</span>
<span class="sd">    Fetch or create a session object for the current session, and</span>
<span class="sd">    return it.  If a session cookie is found in the HTTP request</span>
<span class="sd">    object, use it to look up and return an existing session object.</span>
<span class="sd">    If no session cookie is found, create a new session.</span>
<span class="sd">    Note that this method does *not* cause the new session to be</span>
<span class="sd">    stored in the session manager, nor does it drop a session cookie</span>
<span class="sd">    on the user.  Those are both the responsibility of</span>
<span class="sd">    finish_successful_request().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_publisher</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session_id</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">load_session</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">_set_access_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ACCESS_TIME_RESOLUTION</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.has_session">
    <p>def <span class="ident">has_session</span>(</p><p>self, session_id)</p>
    </div>
    

    
  
    <div class="desc"><p>(session_id : string) -&gt; boolean</p>
<p>Return true if a session identified by 'session_id' exists in
the session manager.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.has_session', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.has_session" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">has_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;(session_id : string) -&gt; boolean</span>
<span class="sd">    Return true if a session identified by &#39;session_id&#39; exists in</span>
<span class="sd">    the session manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">load_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.has_session_cookie">
    <p>def <span class="ident">has_session_cookie</span>(</p><p>self, must_exist=False)</p>
    </div>
    

    
  
    <div class="desc"><p>(must_exist : boolean = false) -&gt; bool</p>
<p>Return true if the request already has a cookie identifying a
session object.  If 'must_exist' is true, the cookie must
correspond to a currently existing session; otherwise (the
default), we just check for the existence of the session cookie
and don't inspect its content at all.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.has_session_cookie', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.has_session_cookie" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">has_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">must_exist</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;(must_exist : boolean = false) -&gt; bool</span>
<span class="sd">    Return true if the request already has a cookie identifying a</span>
<span class="sd">    session object.  If &#39;must_exist&#39; is true, the cookie must</span>
<span class="sd">    correspond to a currently existing session; otherwise (the</span>
<span class="sd">    default), we just check for the existence of the session cookie</span>
<span class="sd">    and don&#39;t inspect its content at all.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_publisher</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">get_cookie</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">must_exist</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_session</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.maintain_session">
    <p>def <span class="ident">maintain_session</span>(</p><p>self, session)</p>
    </div>
    

    
  
    <div class="desc"><p>(session : Session) -&gt; bool</p>
<p>Maintain session information.  This method is called after servicing
an HTTP request, just before the response is returned.  If a session
contains information a cookie is dropped on the client and True is
returned.  If not, the session is forcibly expired and False is
returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.maintain_session', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.maintain_session" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">maintain_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;(session : Session) -&gt; bool</span>
<span class="sd">    Maintain session information.  This method is called after servicing</span>
<span class="sd">    an HTTP request, just before the response is returned.  If a session</span>
<span class="sd">    contains information a cookie is dropped on the client and True is</span>
<span class="sd">    returned.  If not, the session is forcibly expired and False is</span>
<span class="sd">    returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">has_info</span><span class="p">():</span>
        <span class="c"># Session has no useful info -- forget it.  If it previously</span>
        <span class="c"># had useful information and no longer does, we have to</span>
        <span class="c"># explicitly forget it.</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_session</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expire_session</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># This is the first time this session has had useful</span>
        <span class="c"># info -- store it and set the session cookie.</span>
        <span class="n">session</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_session_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_session_cookie</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.new_session">
    <p>def <span class="ident">new_session</span>(</p><p>self, id)</p>
    </div>
    

    
  
    <div class="desc"><p>(id : string) -&gt; Session</p>
<p>Return a new session object, ie. an instance of the session_class
class passed to the constructor (defaults to Session).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.new_session', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.new_session" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">new_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;(id : string) -&gt; Session</span>
<span class="sd">    Return a new session object, ie. an instance of the session_class</span>
<span class="sd">    class passed to the constructor (defaults to Session).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.revoke_session_cookie">
    <p>def <span class="ident">revoke_session_cookie</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove the session cookie from the remote user's session by
resetting the value and maximum age in the response object.  Also
remove the cookie from the request so that further processing of
this request does not see the cookie's revoked value.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.revoke_session_cookie', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.revoke_session_cookie" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">revoke_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove the session cookie from the remote user&#39;s session by</span>
<span class="sd">    resetting the value and maximum age in the response object.  Also</span>
<span class="sd">    remove the cookie from the request so that further processing of</span>
<span class="sd">    this request does not see the cookie&#39;s revoked value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cookie_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_cookie</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">get_cookie</span><span class="p">(</span><span class="n">cookie_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">get_request</span><span class="p">()</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">cookie_name</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.set_session_cookie">
    <p>def <span class="ident">set_session_cookie</span>(</p><p>self, session_id)</p>
    </div>
    

    
  
    <div class="desc"><p>(session_id : string)</p>
<p>Ensure that a session cookie with value 'session_id' will be
returned to the client via the response object.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.set_session_cookie', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.set_session_cookie" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">set_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;(session_id : string)</span>
<span class="sd">    Ensure that a session cookie with value &#39;session_id&#39; will be</span>
<span class="sd">    returned to the client via the response object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_cookie</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="session3.SessionManager.SessionManager.start_request">
    <p>def <span class="ident">start_request</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Called near the beginning of each request: after the HTTPRequest
object has been built, but before we traverse the URL or call the
callable object found by URL traversal.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-session3.SessionManager.SessionManager.start_request', this);">Show source &equiv;</a></p>
  <div id="source-session3.SessionManager.SessionManager.start_request" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">start_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called near the beginning of each request: after the HTTPRequest</span>
<span class="sd">    object has been built, but before we traverse the URL or call the</span>
<span class="sd">    callable object found by URL traversal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
    <span class="n">get_request</span><span class="p">()</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    <span class="n">session</span><span class="o">.</span><span class="n">start_request</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="session3.SessionManager.SessionManager.expired_sessions" class="name">var <span class="ident">expired_sessions</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="session3.SessionManager.SessionManager.session_class" class="name">var <span class="ident">session_class</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="session3.SessionManager.SessionManager.store" class="name">var <span class="ident">store</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
